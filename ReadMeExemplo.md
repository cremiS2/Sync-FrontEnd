# Documenta√ß√£o: Consumo do Backend

Este documento descreve como o frontend consome a API do backend, incluindo configura√ß√£o, estrutura, endpoints e padr√µes utilizados.

---

## üìã √çndice

1. [Configura√ß√£o da API](#configura√ß√£o-da-api)
2. [Cliente HTTP (Axios)](#cliente-http-axios)
3. [Estrutura de Servi√ßos](#estrutura-de-servi√ßos)
4. [Endpoints Dispon√≠veis](#endpoints-dispon√≠veis)
5. [Autentica√ß√£o e Autoriza√ß√£o](#autentica√ß√£o-e-autoriza√ß√£o)
6. [Pagina√ß√£o](#pagina√ß√£o)
7. [Tratamento de Erros](#tratamento-de-erros)
8. [Debug e Logs](#debug-e-logs)

---

## üîß Configura√ß√£o da API

### Arquivo: `src/config/environment.ts`

O frontend utiliza vari√°veis de ambiente para configurar a URL da API:

```typescript
export const ENV_CONFIG = {
  API_URLS: {
    development: 'https://sync-d8hac6hdg3czc4aa.brazilsouth-01.azurewebsites.net',
    production: 'https://sync-d8hac6hdg3czc4aa.brazilsouth-01.azurewebsites.net',
    staging: 'https://sync-d8hac6hdg3czc4aa.brazilsouth-01.azurewebsites.net'
  },
  
  getApiUrl() {
    const env = this.getCurrentEnvironment();
    return import.meta.env.VITE_API_URL || this.API_URLS[env];
  }
};
```

### Vari√°veis de Ambiente (`.env`)

```bash
# URL da API do Backend
VITE_API_URL=https://sync-d8hac6hdg3czc4aa.brazilsouth-01.azurewebsites.net

# Debug da API (true para habilitar logs detalhados)
VITE_DEBUG_API=true
```

---

## üåê Cliente HTTP (Axios)

### Arquivo: `src/services/http.ts`

O cliente HTTP √© configurado com Axios e inclui interceptors para autentica√ß√£o e tratamento de erros.

### Configura√ß√£o Base

```typescript
import axios from 'axios';
import { ENV_CONFIG } from '../config/environment';

const baseURL = ENV_CONFIG.getApiUrl();

export const http = axios.create({
  baseURL,
  headers: { 'Content-Type': 'application/json' },
});
```

### Interceptor de Requisi√ß√£o

**Funcionalidades:**
- Adiciona token JWT no header `Authorization`
- Valida expira√ß√£o do token
- Remove tokens expirados automaticamente
- Logs detalhados de debug

```typescript
http.interceptors.request.use((config) => {
  const token = localStorage.getItem(STORAGE_KEYS.USER_TOKEN);
  
  if (token) {
    // Validar expira√ß√£o do token
    const payload = JSON.parse(atob(token.split('.')[1]));
    const now = Math.floor(Date.now() / 1000);
    
    if (payload.exp < now) {
      localStorage.removeItem(STORAGE_KEYS.USER_TOKEN);
      window.location.href = '/login';
      return config;
    }
    
    // Adicionar header Authorization
    config.headers['Authorization'] = `Bearer ${token}`;
  }
  
  return config;
});
```

### Interceptor de Resposta

**Funcionalidades:**
- Logs de respostas bem-sucedidas
- Tratamento de erros 401 (n√£o autorizado)
- Detec√ß√£o de erros de rede (CORS, timeout)
- Logs detalhados de erros

```typescript
http.interceptors.response.use(
  (response) => response,
  (error) => {
    // Erro 401: Token inv√°lido ou expirado
    if (error?.response?.status === 401) {
      localStorage.removeItem(STORAGE_KEYS.USER_TOKEN);
    }
    
    // Erro de rede
    if (!error?.response) {
      console.error('Poss√≠vel problema de CORS, timeout ou servidor offline');
    }
    
    return Promise.reject(error);
  }
);
```

---

## üìÅ Estrutura de Servi√ßos

Todos os servi√ßos seguem o mesmo padr√£o de organiza√ß√£o:

```
src/services/
‚îú‚îÄ‚îÄ http.ts                          # Cliente HTTP base
‚îú‚îÄ‚îÄ auth.ts                          # Autentica√ß√£o
‚îú‚îÄ‚îÄ users.ts                         # Gerenciamento de usu√°rios
‚îú‚îÄ‚îÄ employees.ts                     # Gerenciamento de funcion√°rios
‚îú‚îÄ‚îÄ machines.ts                      # Gerenciamento de m√°quinas
‚îú‚îÄ‚îÄ machineModels.ts                 # Modelos de m√°quinas
‚îú‚îÄ‚îÄ departments.ts                   # Departamentos
‚îú‚îÄ‚îÄ sectors.ts                       # Setores
‚îî‚îÄ‚îÄ allocatedEmployeeMachine.ts      # Aloca√ß√µes funcion√°rio-m√°quina
```

### Padr√£o de Implementa√ß√£o

Cada servi√ßo exporta fun√ß√µes para opera√ß√µes CRUD:

```typescript
// Listar (com pagina√ß√£o e filtros)
export function listItems(query: ListQuery): Promise<{ data: Page<Item> }>

// Buscar por ID
export function getItem(id: number): Promise<{ data: Item }>

// Criar
export function createItem(dto: ItemDTO): Promise<{ headers: any }>

// Atualizar
export function updateItem(id: number, dto: ItemDTO): Promise<void>

// Deletar
export function deleteItem(id: number): Promise<void>
```

---

## üîå Endpoints Dispon√≠veis

### Arquivo: `src/utils/constants.ts`

```typescript
export const API_ENDPOINTS = {
  LOGIN: '/login',
  SIGN_IN: '/sign-in',
  USER: '/user',
  EMPLOYEE: '/employee',
  SECTOR: '/sector',
  DEPARTMENT: '/department',
  MACHINE: '/machine',
  MACHINE_MODEL: '/machine-model',
  ALLOCATED_EMPLOYEE_MACHINE: '/allocated-employee-machine',
};
```

---

## üîê Autentica√ß√£o e Autoriza√ß√£o

### Arquivo: `src/services/auth.ts`

### 1. Login

**Endpoint:** `POST /login`

```typescript
interface LoginRequest {
  email: string;
  password: string;
}

interface LoginResponse {
  token: string;
  exp?: number;
}

// Uso
const response = await login({ email, password });
// Token √© automaticamente salvo no localStorage
```

**Fluxo:**
1. Envia credenciais para o backend
2. Recebe token JWT
3. Salva token no `localStorage` com chave `user_token`
4. Token √© automaticamente inclu√≠do em todas as requisi√ß√µes subsequentes

### 2. Sign In (Registro)

**Endpoint:** `POST /sign-in`

```typescript
interface SignInRequest {
  email: string;
  password: string;
  roles?: string[];
}

// Uso
await signIn({ email, password, roles });
```

### 3. Logout

```typescript
// Remove token do localStorage
logout();
```

### 4. Verifica√ß√µes de Autentica√ß√£o

```typescript
// Verificar se usu√°rio est√° autenticado
const isAuth = isAuthenticated();

// Obter token atual
const token = getToken();

// Limpar token expirado
const wasExpired = clearExpiredToken();
```

---

## üë• Funcion√°rios (Employees)

### Arquivo: `src/services/employees.ts`

### Listar Funcion√°rios

**Endpoint:** `GET /employee`

```typescript
interface ListEmployeesQuery {
  employeeName?: string;
  employeeId?: number;
  shift?: string;
  sectorName?: string;
  pageNumber?: number;
  pageSize?: number;
}

// Uso
const response = await listEmployees({
  employeeName: 'Jo√£o',
  shift: 'Manh√£',
  pageNumber: 0,
  pageSize: 10
});
```

**Par√¢metros de Query:**
- `employee-name`: Nome do funcion√°rio (filtro)
- `employee-id`: ID do funcion√°rio (filtro)
- `shift`: Turno (filtro)
- `sector-name`: Nome do setor (filtro)
- `page-number`: N√∫mero da p√°gina (pagina√ß√£o)
- `page-size`: Tamanho da p√°gina (pagina√ß√£o)

### Buscar Funcion√°rio

**Endpoint:** `GET /employee/{id}`

```typescript
const response = await getEmployee(123);
```

### Criar Funcion√°rio

**Endpoint:** `POST /employee`

```typescript
interface EmployeeDTO {
  name: string;
  email: string;
  shift: string;
  sectorId: number;
  // ... outros campos
}

const response = await createEmployee(employeeDTO);
// Location do recurso criado em: response.headers.location
```

### Atualizar Funcion√°rio

**Endpoint:** `PUT /employee/{id}`

```typescript
await updateEmployee(123, employeeDTO);
```

### Deletar Funcion√°rio

**Endpoint:** `DELETE /employee/{id}`

```typescript
await deleteEmployee(123);
```

---

## üè≠ M√°quinas (Machines)

### Arquivo: `src/services/machines.ts`

### Listar M√°quinas

**Endpoint:** `GET /machine`

```typescript
interface ListMachinesQuery {
  machineName?: string;
  sectorName?: string;
  statusMachine?: string;
  pageNumber?: number;
  pageSize?: number;
}

// Uso
const response = await listMachines({
  machineName: 'Torno CNC',
  statusMachine: 'Operando',
  pageNumber: 0,
  pageSize: 10
});
```

**Par√¢metros de Query:**
- `machine-name`: Nome da m√°quina (filtro)
- `sector-name`: Nome do setor (filtro)
- `status-machine`: Status da m√°quina (filtro)
  - Valores: `'Operando'`, `'Parada'`, `'Manuten√ß√£o'`
- `page-number`: N√∫mero da p√°gina
- `page-size`: Tamanho da p√°gina

### Buscar M√°quina

**Endpoint:** `GET /machine/{id}`

```typescript
const response = await getMachine(456);
```

### Criar M√°quina

**Endpoint:** `POST /machine`

```typescript
interface MachineDTO {
  name: string;
  modelId: number;
  sectorId: number;
  status: string;
  // ... outros campos
}

const response = await createMachine(machineDTO);
```

### Atualizar M√°quina

**Endpoint:** `PUT /machine/{id}`

```typescript
await updateMachine(456, machineDTO);
```

### Deletar M√°quina

**Endpoint:** `DELETE /machine/{id}`

```typescript
await deleteMachine(456);
```

---

## üè¢ Departamentos (Departments)

### Arquivo: `src/services/departments.ts`

### Listar Departamentos

**Endpoint:** `GET /department`

```typescript
interface ListDepartmentsQuery {
  departmentName?: string;
  statusDepartment?: string;
  departmentBudget?: number;
  pageSize?: number;
  pageNumber?: number;
}

// Uso
const response = await listDepartments({
  departmentName: 'Produ√ß√£o',
  statusDepartment: 'active',
  pageNumber: 0,
  pageSize: 10
});
```

**Par√¢metros de Query:**
- `department-name`: Nome do departamento (filtro)
- `status-department`: Status do departamento (filtro)
- `department-budget`: Or√ßamento do departamento (filtro)
- `page-number`: N√∫mero da p√°gina
- `page-size`: Tamanho da p√°gina

### Buscar Departamento

**Endpoint:** `GET /department/{id}`

```typescript
const response = await getDepartment(789);
```

### Criar Departamento

**Endpoint:** `POST /department`

```typescript
interface DepartmentDTO {
  name: string;
  description: string;
  location: string;
  budget: number;
  status: string;
}

const response = await createDepartment(departmentDTO);
```

### Atualizar Departamento

**Endpoint:** `PUT /department/{id}`

```typescript
await updateDepartment(789, departmentDTO);
```

### Deletar Departamento

**Endpoint:** `DELETE /department/{id}`

```typescript
await deleteDepartment(789);
```

---

## üè≠ Setores (Sectors)

### Arquivo: `src/services/sectors.ts`

### Listar Setores

**Endpoint:** `GET /sector`

```typescript
interface ListSectorsQuery {
  departmentName?: string;
  sectorName?: string;
  pageSize?: number;
  pageNumber?: number;
}

// Uso
const response = await listSectors({
  departmentName: 'Produ√ß√£o',
  sectorName: 'Montagem',
  pageNumber: 0,
  pageSize: 10
});
```

**Par√¢metros de Query:**
- `department-name`: Nome do departamento (filtro)
- `sector-name`: Nome do setor (filtro)
- `page-number`: N√∫mero da p√°gina
- `page-size`: Tamanho da p√°gina

### Buscar Setor

**Endpoint:** `GET /sector/{id}`

```typescript
const response = await getSector(321);
```

### Criar Setor

**Endpoint:** `POST /sector`

```typescript
interface SectorDTO {
  name: string;
  department: number;              // ID do departamento (obrigat√≥rio)
  maximumQuantEmployee: number;    // Quantidade m√°xima de funcion√°rios (obrigat√≥rio)
  efficiency: number;
  description: string;             // Obrigat√≥rio
}

const response = await createSector(sectorDTO);
```

### Atualizar Setor

**Endpoint:** `PUT /sector/{id}`

```typescript
await updateSector(321, sectorDTO);
```

### Deletar Setor

**Endpoint:** `DELETE /sector/{id}`

```typescript
await deleteSector(321);
```

---

## üîß Modelos de M√°quinas (Machine Models)

### Arquivo: `src/services/machineModels.ts`

### Listar Modelos

**Endpoint:** `GET /machine-model`

```typescript
interface ListMachineModelsQuery {
  numeroPagina?: number;
  tamanhoPagina?: number;
}

// Uso
const response = await listMachineModels({
  numeroPagina: 0,
  tamanhoPagina: 10
});
```

**Par√¢metros de Query:**
- `numero-pagina`: N√∫mero da p√°gina
- `tamanho-pagina`: Tamanho da p√°gina

### Buscar Modelo

**Endpoint:** `GET /machine-model/{id}`

```typescript
const response = await getMachineModel(111);
```

### Criar Modelo

**Endpoint:** `POST /machine-model`

```typescript
const response = await createMachineModel(modelDTO);
```

### Atualizar Modelo

**Endpoint:** `PUT /machine-model/{id}`

```typescript
await updateMachineModel(111, modelDTO);
```

### Deletar Modelo

**Endpoint:** `DELETE /machine-model/{id}`

```typescript
await deleteMachineModel(111);
```

---

## üë§ Usu√°rios (Users)

### Arquivo: `src/services/users.ts`

### Listar Usu√°rios

**Endpoint:** `GET /user`

```typescript
interface ListUsersQuery {
  pageNumber?: number;
  pageSize?: number;
}

// Uso
const response = await listUsers({
  pageNumber: 0,
  pageSize: 10
});
```

**Par√¢metros de Query:**
- `page-number`: N√∫mero da p√°gina
- `page-size`: Tamanho da p√°gina

### Buscar Usu√°rio

**Endpoint:** `GET /user/{id}`

```typescript
const response = await getUser(555);
```

### Atualizar Usu√°rio

**Endpoint:** `PUT /user/{id}`

```typescript
await updateUser(555, userDTO);
```

### Deletar Usu√°rio

**Endpoint:** `DELETE /user/{id}`

```typescript
await deleteUser(555);
```

---

## üîó Aloca√ß√µes Funcion√°rio-M√°quina

### Arquivo: `src/services/allocatedEmployeeMachine.ts`

### Listar Aloca√ß√µes

**Endpoint:** `GET /allocated-employee-machine`

```typescript
interface ListAllocationsQuery {
  pageSize?: number;
  pageNumber?: number;
  nameEmployee?: string;
  nameEmployeeChanged?: string;
}

// Uso
const response = await listAllocations({
  nameEmployee: 'Jo√£o Silva',
  pageNumber: 0,
  pageSize: 10
});
```

**Par√¢metros de Query:**
- `page-size`: Tamanho da p√°gina
- `page-number`: N√∫mero da p√°gina
- `name-employee`: Nome do funcion√°rio (filtro)
- `name-employee-changed`: Nome do funcion√°rio alterado (filtro)

### Criar Aloca√ß√£o

**Endpoint:** `POST /allocated-employee-machine`

```typescript
const response = await createAllocation(allocationDTO);
```

---

## üìÑ Pagina√ß√£o

### Arquivo: `src/types/api.ts`

Todas as listagens retornam um objeto paginado:

```typescript
interface Page<T> {
  content: T[];              // Array de itens
  totalElements: number;     // Total de elementos
  totalPages: number;        // Total de p√°ginas
  size: number;              // Tamanho da p√°gina
  number: number;            // N√∫mero da p√°gina atual
  first: boolean;            // √â a primeira p√°gina?
  last: boolean;             // √â a √∫ltima p√°gina?
  numberOfElements: number;  // N√∫mero de elementos na p√°gina atual
  empty: boolean;            // Est√° vazia?
}
```

### Exemplo de Uso

```typescript
const response = await listEmployees({
  pageNumber: 0,    // Primeira p√°gina (zero-indexed)
  pageSize: 10      // 10 itens por p√°gina
});

const employees = response.data.content;
const totalPages = response.data.totalPages;
const totalItems = response.data.totalElements;
```

### Constantes de Pagina√ß√£o

```typescript
export const PAGINATION = {
  DEFAULT_PAGE_SIZE: 10,
  PAGE_SIZE_OPTIONS: [5, 10, 25, 50],
};
```

---

## ‚ö†Ô∏è Tratamento de Erros

### Estrutura de Erro

Todos os servi√ßos capturam e logam erros detalhadamente:

```typescript
try {
  const response = await listEmployees(query);
} catch (err: any) {
  console.error('Error details:', {
    status: err?.response?.status,
    data: err?.response?.data,
    message: err?.response?.data?.message,
    validationErrors: err?.response?.data?.validationErrors
  });
  throw err;
}
```

### C√≥digos de Status Comuns

- **200 OK**: Requisi√ß√£o bem-sucedida
- **201 Created**: Recurso criado com sucesso
- **204 No Content**: Opera√ß√£o bem-sucedida sem conte√∫do de retorno
- **400 Bad Request**: Dados inv√°lidos
- **401 Unauthorized**: Token inv√°lido ou expirado
- **403 Forbidden**: Sem permiss√£o
- **404 Not Found**: Recurso n√£o encontrado
- **422 Unprocessable Entity**: Erro de valida√ß√£o
- **500 Internal Server Error**: Erro no servidor

### Tratamento Autom√°tico

O interceptor de resposta trata automaticamente:

1. **Erro 401**: Remove token e redireciona para login
2. **Erro de Rede**: Detecta problemas de CORS, timeout ou servidor offline
3. **Logs Detalhados**: Registra todos os detalhes do erro para debug

---

## üêõ Debug e Logs

### Habilitando Debug

No arquivo `.env`:

```bash
VITE_DEBUG_API=true
```

### Logs Dispon√≠veis

Quando o debug est√° habilitado, voc√™ ver√°:

#### 1. Logs de Requisi√ß√£o

```
=== HTTP INTERCEPTOR REQUEST ===
URL: https://api.example.com/employee
M√©todo: GET
Token encontrado: true
Token (primeiros 30 chars): eyJhbGciOiJIUzI1NiIsInR5cCI6...
Authorization header adicionado: Bearer eyJhbGciOiJIUz...
```

#### 2. Logs de Resposta

```
[HTTP] Response: {
  status: 200,
  url: '/employee',
  method: 'GET'
}
```

#### 3. Logs de Erro

```
=== HTTP INTERCEPTOR - ERRO 401 ===
URL completa: https://api.example.com/employee
M√©todo: GET
Headers da requisi√ß√£o: { Authorization: 'Bearer ...' }
Headers da resposta: { ... }
Dados da resposta: { message: 'Token inv√°lido' }
```

#### 4. Logs de Servi√ßo

```
[employees] listEmployees params: { 
  employee-name: 'Jo√£o',
  page-number: 0,
  page-size: 10
}
[employees] listEmployees OK items: 5
```

### Desabilitando Logs em Produ√ß√£o

```bash
VITE_DEBUG_API=false
```

Ou simplesmente remova a vari√°vel do `.env`.

---

## üìù Boas Pr√°ticas

### 1. Sempre Use os Servi√ßos

‚ùå **N√£o fa√ßa:**
```typescript
import axios from 'axios';
axios.get('https://api.example.com/employee');
```

‚úÖ **Fa√ßa:**
```typescript
import { listEmployees } from '@/services/employees';
const response = await listEmployees();
```

### 2. Trate Erros Adequadamente

```typescript
try {
  const response = await createEmployee(employeeDTO);
  // Sucesso
} catch (error: any) {
  if (error?.response?.status === 422) {
    // Erro de valida√ß√£o
    const validationErrors = error.response.data.validationErrors;
    // Mostrar erros ao usu√°rio
  } else {
    // Erro gen√©rico
    // Mostrar mensagem de erro
  }
}
```

### 3. Use TypeScript

Todos os servi√ßos s√£o tipados. Aproveite o IntelliSense:

```typescript
// TypeScript vai sugerir os campos dispon√≠veis
const query: ListEmployeesQuery = {
  employeeName: 'Jo√£o',
  shift: 'Manh√£',
  pageNumber: 0,
  pageSize: 10
};
```

### 4. Pagina√ß√£o

Sempre implemente pagina√ß√£o para listas grandes:

```typescript
const [page, setPage] = useState(0);
const [pageSize, setPageSize] = useState(10);

const response = await listEmployees({
  pageNumber: page,
  pageSize: pageSize
});
```

### 5. Loading States

Sempre mostre feedback visual durante requisi√ß√µes:

```typescript
const [loading, setLoading] = useState(false);

const loadData = async () => {
  setLoading(true);
  try {
    const response = await listEmployees();
    // Processar dados
  } catch (error) {
    // Tratar erro
  } finally {
    setLoading(false);
  }
};
```

---

## üîí Seguran√ßa

### 1. Token JWT

- Armazenado em `localStorage` com chave `user_token`
- Validado automaticamente antes de cada requisi√ß√£o
- Removido automaticamente se expirado
- Inclu√≠do em todas as requisi√ß√µes autenticadas

### 2. HTTPS

Todas as requisi√ß√µes s√£o feitas via HTTPS:
```
https://sync-d8hac6hdg3czc4aa.brazilsouth-01.azurewebsites.net
```

### 3. Headers de Seguran√ßa

```typescript
headers: {
  'Content-Type': 'application/json',
  'Authorization': 'Bearer <token>'
}
```

---

## üöÄ Exemplo Completo

### Componente React com Listagem de Funcion√°rios

```typescript
import React, { useState, useEffect } from 'react';
import { listEmployees, type ListEmployeesQuery } from '@/services/employees';
import type { Employee } from '@/types';

export function EmployeeList() {
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [page, setPage] = useState(0);
  const [totalPages, setTotalPages] = useState(0);

  const loadEmployees = async () => {
    setLoading(true);
    setError(null);
    
    try {
      const query: ListEmployeesQuery = {
        pageNumber: page,
        pageSize: 10,
        shift: 'Manh√£'
      };
      
      const response = await listEmployees(query);
      
      setEmployees(response.data.content);
      setTotalPages(response.data.totalPages);
    } catch (err: any) {
      setError(err?.response?.data?.message || 'Erro ao carregar funcion√°rios');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadEmployees();
  }, [page]);

  if (loading) return <div>Carregando...</div>;
  if (error) return <div>Erro: {error}</div>;

  return (
    <div>
      <h1>Funcion√°rios</h1>
      <ul>
        {employees.map(employee => (
          <li key={employee.id}>{employee.name}</li>
        ))}
      </ul>
      <button onClick={() => setPage(p => p - 1)} disabled={page === 0}>
        Anterior
      </button>
      <span>P√°gina {page + 1} de {totalPages}</span>
      <button onClick={() => setPage(p => p + 1)} disabled={page >= totalPages - 1}>
        Pr√≥xima
      </button>
    </div>
  );
}
```

---

## üìö Refer√™ncias

- **Axios Documentation**: https://axios-http.com/
- **JWT.io**: https://jwt.io/
- **TypeScript**: https://www.typescriptlang.org/

---

## üìû Suporte

Para d√∫vidas ou problemas:

1. Verifique os logs no console do navegador (com `VITE_DEBUG_API=true`)
2. Confirme que a URL da API est√° correta no `.env`
3. Verifique se o token JWT est√° v√°lido
4. Consulte a documenta√ß√£o do backend

---

**√öltima atualiza√ß√£o:** 2024
**Vers√£o:** 1.0.0
